<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardioAI - ECG Classifier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .upload-area {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover { border-color: #2a5298; background: #e8f0fe; }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        
        .btn-primary {
            background: #2a5298;
            color: white;
        }
        
        .btn-primary:hover { background: #1e3c72; }
        
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: none;
        }
        
        .result-card.show { display: block; }
        
        .diagnosis-box {
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .metric { text-align: center; padding: 15px; }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .visualization img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .probability-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .probability-fill {
            height: 100%;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
            transition: width 1s ease;
        }
        
        input[type="file"] { display: none; }
        
        .patient-input {
            margin-bottom: 15px;
        }
        
        .patient-input label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .patient-input input, .patient-input select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #2a5298;
            border-radius: 6px;
            color: #2a5298;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #2a5298;
            color: white;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .ecg-chart-wrapper {
            position: relative;
        }

        #ecgChart {
            cursor: grab;
            transition: transform 0.3s ease;
        }

        #ecgChart:active {
            cursor: grabbing;
        }

        #ecgChart:hover {
            transform: scale(1.02);
        }

        .zoom-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(42, 82, 152, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ü´Ä CardioAI Clinical Platform</h1>
            <p>AI-Assisted ECG Arrhythmia Classification System</p>
        </div>
    </div>

    <div class="container">
        <!-- Control Panel -->
        <div class="control-panel">
            <!-- <h2>Patient Information</h2>
            <div class="grid">
                <div class="patient-input">
                    <label>Patient ID</label>
                    <input type="text" id="patientId" placeholder="ECG-2025-001">
                </div>
                <div class="patient-input">
                    <label>Age</label>
                    <input type="number" id="patientAge" placeholder="65">
                </div>
                <div class="patient-input">
                    <label>Gender</label>
                    <select id="patientGender">
                        <option value="">Select...</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div> -->

            <h2 style="margin-top: 25px;">ECG Data Upload</h2>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3em; margin-bottom: 10px;">üìä</div>
                <div style="font-size: 1.1em; margin-bottom: 5px;">Click to upload ECG CSV file</div>
                <div style="font-size: 0.9em; color: #6c757d;">360 samples ‚Ä¢ Single lead ‚Ä¢ CSV format</div>
                <div id="fileName" style="margin-top: 15px; color: #28a745; font-weight: 600;"></div>
            </div>
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)">

           <div class="text-center mt-4">
    <button class="btn btn-primary me-2" id="analyzeBtn" onclick="analyzeECG()" disabled>
        üî¨ Analyze ECG
    </button>

    <select class="form-select d-inline-block w-auto" id="demoSelect" onchange="loadDemo(this.value)">
        <option value="" selected disabled>üìã Load Demo Data</option>
        <option value="0">Demo Data 1</option>
        <option value="1">Demo Data 2</option>
        <option value="2">Demo Data 3</option>
        <option value="3">Demo Data 4</option>
    </select>
</div>

            <!-- ECG Preview Chart -->
            <div id="ecgPreviewContainer" style="margin-top: 40px; display: none;">
                <h3 style="margin-bottom: 15px;">üìà ECG Signal Preview</h3>
                
                <div class="chart-controls">
                    <button class="control-btn" onclick="zoomIn()">üîç Zoom In</button>
                    <button class="control-btn" onclick="zoomOut()">üîç Zoom Out</button>
                    <button class="control-btn" onclick="resetZoom()">‚Ü∫ Reset View</button>
                    <button class="control-btn" onclick="panLeft()">‚Üê Pan Left</button>
                    <button class="control-btn" onclick="panRight()">Pan Right ‚Üí</button>
                </div>

                <div class="ecg-chart-wrapper">
                    <div class="zoom-indicator" id="zoomIndicator">100%</div>
                    <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e0e0e0;">
                        <canvas id="ecgChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="spinner"></div>
            <div style="font-size: 1.2em; color: #6c757d;">Analyzing ECG Signal...</div>
            <div style="font-size: 0.9em; color: #adb5bd; margin-top: 10px;">
                Processing with multi-attention neural network
            </div>
        </div>

        <!-- Results -->
        <div class="result-card" id="resultsCard">
            <h2>Analysis Results</h2>
            <div class="diagnosis-box" id="diagnosisBox">
                <h1 id="diagnosisTitle" style="margin-bottom: 10px;"></h1>
                <p id="diagnosisDesc" style="font-size: 1.1em; color: #666;"></p>
            </div>

            <div class="grid">
                <div class="metric">
                    <div class="metric-value" id="confidenceValue">0%</div>
                    <div class="metric-label">Confidence</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="severityValue">-</div>
                    <div class="metric-label">Severity</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="reconstructionError">-</div>
                    <div class="metric-label">Reconstruction MSE</div>
                </div>
            </div>

            <div id="recommendationBox" style="padding: 20px; background: #fff9e6; border: 2px solid #ffd966; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #856404; margin-bottom: 10px;">‚öïÔ∏è Clinical Recommendation</h3>
                <p id="recommendationText" style="color: #856404; margin: 0;"></p>
            </div>

            <h3>Probability Distribution</h3>
            <div id="probabilityBars"></div>

            <h3 style="margin-top: 30px;">ECG Signal Analysis</h3>
            <div class="visualization">
                <img id="visualizationImg" src="" alt="ECG Visualization" style="display: none;">
            </div>

            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <h3>üìã Clinical Notes</h3>
                <p id="clinicalNotes" style="color: #495057;"></p>
            </div>
        </div>

        <!-- Disclaimer -->
        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin-top: 25px;">
            <h3 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è Medical Disclaimer</h3>
            <p style="color: #856404; margin: 0;">
                This AI-powered diagnostic tool is for research and educational purposes only. 
                All findings must be verified by a qualified cardiologist or physician. 
                Do not use as the sole basis for clinical decisions.
            </p>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let ecgData = null;
        let ecgChart = null;
        let currentZoom = 1;
        let panOffset = 0;

        function showECGPreview(signal) {
            if (!signal || signal.length === 0) return;

            const ctx = document.getElementById('ecgChart');
            if (!ctx) return;

            if (ecgChart) {
                ecgChart.destroy();
            }

            const mean = signal.reduce((a, b) => a + b, 0) / signal.length;
            const normalizedSignal = signal.map(v => v - mean);
            
            const startIdx = Math.max(0, Math.floor(panOffset));
            const endIdx = Math.min(signal.length, Math.ceil(startIdx + signal.length / currentZoom));
            const visibleSignal = normalizedSignal.slice(startIdx, endIdx);
            const labels = Array.from({ length: visibleSignal.length }, (_, i) => ((startIdx + i) / 360).toFixed(3));
            
            ecgChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Original ECG',
                        data: visibleSignal,
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.02)',
                        borderWidth: 1.5,
                        fill: true,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                font: { size: 12, weight: '500' },
                                color: '#2c3e50',
                                padding: 10,
                                boxWidth: 40,
                                boxHeight: 2,
                                usePointStyle: false
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(44, 62, 80, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 10,
                            cornerRadius: 6,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return 'Time: ' + context[0].label + ' s';
                                },
                                label: function(context) {
                                    return 'Amplitude: ' + context.parsed.y.toFixed(4) + ' mV';
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Original ECG Signal',
                            font: { size: 16, weight: '600' },
                            color: '#2c3e50',
                            padding: { top: 10, bottom: 20 }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: false
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)',
                                drawBorder: true,
                                lineWidth: 1
                            },
                            ticks: {
                                maxTicksLimit: 10,
                                color: '#6c757d',
                                font: { size: 10 },
                                padding: 5
                            },
                            border: {
                                color: '#2c3e50',
                                width: 1
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amplitude (normalized)',
                                color: '#2c3e50',
                                font: { size: 11, weight: '500' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.08)',
                                drawBorder: true,
                                lineWidth: 1
                            },
                            ticks: {
                                color: '#6c757d',
                                font: { size: 10 },
                                padding: 5,
                                maxTicksLimit: 8
                            },
                            border: {
                                color: '#2c3e50',
                                width: 1
                            }
                        }
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 20,
                            top: 0,
                            bottom: 10
                        }
                    }
                }
            });

            document.getElementById('ecgPreviewContainer').style.display = 'block';
            updateZoomIndicator();
        }

        function updateZoomIndicator() {
            document.getElementById('zoomIndicator').textContent = Math.round(currentZoom * 100) + '%';
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.5, 10);
            showECGPreview(ecgData);
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.5, 0.5);
            panOffset = Math.max(0, panOffset);
            showECGPreview(ecgData);
        }

        function resetZoom() {
            currentZoom = 1;
            panOffset = 0;
            showECGPreview(ecgData);
        }

        function panLeft() {
            const step = ecgData.length / currentZoom / 10;
            panOffset = Math.max(0, panOffset - step);
            showECGPreview(ecgData);
        }

        function panRight() {
            const step = ecgData.length / currentZoom / 10;
            const maxOffset = ecgData.length - (ecgData.length / currentZoom);
            panOffset = Math.min(maxOffset, panOffset + step);
            showECGPreview(ecgData);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `‚úì ${file.name}`;
                document.getElementById('analyzeBtn').disabled = false;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    ecgData = [];
                    for (let line of lines) {
                        const value = parseFloat(line.trim().split(',')[0]);
                        if (!isNaN(value)) ecgData.push(value);
                    }
                    currentZoom = 1;
                    panOffset = 0;
                    showECGPreview(ecgData);
                };
                reader.readAsText(file);
            }
        }

        async function loadDemo(idx) {
            try {
                const response = await fetch('/demo');
                const data = await response.json();
                ecgData = data.demo_ecg_data[idx];
                document.getElementById('fileName').textContent = '‚úì Demo data loaded';
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('patientId').value = 'DEMO-' + Date.now();
                document.getElementById('patientAge').value = '65';
                document.getElementById('patientGender').value = 'male';
                currentZoom = 1;
                panOffset = 0;
                showECGPreview(ecgData);
                alert('Demo data loaded successfully!');
            } catch (error) {
                alert('Error loading demo data: ' + error.message);
            }
        }

        async function analyzeECG() {
    if (!ecgData) {
        alert('Please upload ECG data first');
        return;
    }

    document.getElementById('loadingState').classList.add('show');
    document.getElementById('resultsCard').classList.remove('show');

    try {
        const formData = new FormData();
        formData.append('ecg_data', JSON.stringify(ecgData));
        // Patient information fields removed from formData

        const response = await fetch('/predict', { method: 'POST', body: formData });
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        displayResults(result);
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        document.getElementById('loadingState').classList.remove('show');
    }
}

        function displayResults(result) {
            document.getElementById('resultsCard').classList.add('show');
            const diagnosisBox = document.getElementById('diagnosisBox');
            diagnosisBox.style.backgroundColor = result.color + '22';
            diagnosisBox.style.borderLeft = `5px solid ${result.color}`;
            document.getElementById('diagnosisTitle').textContent = `${result.icon} ${result.class_name}`;
            document.getElementById('diagnosisTitle').style.color = result.color;
            document.getElementById('diagnosisDesc').textContent = result.description;
            document.getElementById('confidenceValue').textContent = result.confidence.toFixed(1) + '%';
            document.getElementById('severityValue').textContent = result.severity;
            document.getElementById('reconstructionError').textContent = result.reconstruction_error.toFixed(6);
            document.getElementById('recommendationText').textContent = result.recommendation;
            document.getElementById('clinicalNotes').textContent = result.clinical_notes;

            const probabilityBars = document.getElementById('probabilityBars');
            probabilityBars.innerHTML = '';
            for (const [className, prob] of Object.entries(result.all_probabilities)) {
                const barHtml = `
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: 600;">${className}</span>
                            <span style="font-weight: bold;">${prob.toFixed(2)}%</span>
                        </div>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: ${prob}%; background: linear-gradient(90deg, #2a5298, #1e3c72);"></div>
                        </div>
                    </div>`;
                probabilityBars.innerHTML += barHtml;
            }

            const img = document.getElementById('visualizationImg');
            img.src = 'data:image/png;base64,' + result.visualization;
            img.style.display = 'block';
            document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>